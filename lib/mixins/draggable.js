"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.default = void 0;
var _easy = require("easy");
var _event = require("../utilities/event");
var _constants = require("../constants");
var LEFT_MOUSE_BUTTON = _easy.constants.LEFT_MOUSE_BUTTON;
function enableDragging() {
    var timeout = null, topOffset = null, leftOffset = null, startMouseTop = null, startMouseLeft = null;
    this.setState({
        timeout: timeout,
        topOffset: topOffset,
        leftOffset: leftOffset,
        startMouseTop: startMouseTop,
        startMouseLeft: startMouseLeft
    });
    this.onMouseDown(mouseDownHandler, this);
}
function disableDragging() {
    this.offMouseDown(mouseDownHandler, this);
}
function isDragging() {
    var dragging = this.hasClass("dragging");
    return dragging;
}
function getTimeout() {
    var state = this.getState(), timeout = state.timeout;
    return timeout;
}
function startDragging(mouseTop, mouseLeft) {
    var bounds = this.getBounds(), eventType = _constants.START_DRAGGING, boundsTop = bounds.getTop(), boundsLeft = bounds.getLeft(), topOffset = mouseTop - boundsTop, leftOffset = mouseLeft - boundsLeft, startMouseTop = mouseTop, startMouseLeft = mouseLeft, relativeMouseTop = mouseTop - startMouseTop, relativeMouseLeft = mouseLeft - startMouseLeft;
    this.addClass("dragging");
    this.setTopOffset(topOffset);
    this.setLeftOffset(leftOffset);
    this.setStartMouseTop(startMouseTop);
    this.setStartMouseLeft(startMouseLeft);
    this.callHandlers(eventType, relativeMouseTop, relativeMouseLeft);
    this.dragging(mouseTop, mouseLeft);
}
function stopDragging(mouseTop, mouseLeft) {
    // const explorer = this.getExplorer(),
    //       escapeKeyStopsDraggingOptionPresent = explorer.isOptionPresent(ESCAPE_KEY_STOPS_DRAGGING);
    //
    // if (escapeKeyStopsDraggingOptionPresent) {
    //   this.offKeyDown();
    // }
    var eventType = _constants.STOP_DRAGGING, startMouseTop = this.getStartMouseTop(), startMouseLeft = this.getStartMouseLeft(), relativeMouseTop = mouseTop - startMouseTop, relativeMouseLeft = mouseLeft - startMouseLeft;
    this.callHandlers(eventType, relativeMouseTop, relativeMouseLeft);
    this.removeClass("dragging");
}
function dragging(mouseTop, mouseLeft) {
    var eventType = _constants.DRAGGING, scrollTop = _easy.window.getScrollTop(), scrollLeft = _easy.window.getScrollLeft(), topOffset = this.getTopOffset(), leftOffset = this.getLeftOffset(), startMouseTop = this.getStartMouseTop(), startMouseLeft = this.getStartMouseLeft(), relativeMouseTop = mouseTop - startMouseTop, relativeMouseLeft = mouseLeft - startMouseLeft;
    var top = startMouseTop + relativeMouseTop - topOffset - scrollTop, left = startMouseLeft + relativeMouseLeft - leftOffset - scrollLeft;
    top = "".concat(top, "px"); ///
    left = "".concat(left, "px"); ///
    var css = {
        top: top,
        left: left
    };
    this.css(css);
    this.callHandlers(eventType, relativeMouseTop, relativeMouseLeft);
    var explorer = this.getExplorer();
    explorer.dragging(this);
}
function callHandlers(eventType, relativeMouseTop, relativeMouseLeft) {
    var eventListeners = this.findEventListeners(eventType);
    eventListeners.forEach(function(eventListener) {
        var handler = eventListener.handler, element = eventListener.element;
        handler.call(element, relativeMouseTop, relativeMouseLeft);
    });
}
function resetTimeout() {
    var timeout = null;
    this.updateTimeout(timeout);
}
function updateTimeout(timeout) {
    this.updateState({
        timeout: timeout
    });
}
function getTopOffset() {
    var state = this.getState(), topOffset = state.topOffset;
    return topOffset;
}
function getLeftOffset() {
    var state = this.getState(), leftOffset = state.leftOffset;
    return leftOffset;
}
function getStartMouseTop() {
    var state = this.getState(), startMouseTop = state.startMouseTop;
    return startMouseTop;
}
function getStartMouseLeft() {
    var state = this.getState(), startMouseLeft = state.startMouseLeft;
    return startMouseLeft;
}
function setTopOffset(topOffset) {
    this.updateState({
        topOffset: topOffset
    });
}
function setLeftOffset(leftOffset) {
    this.updateState({
        leftOffset: leftOffset
    });
}
function setStartMouseTop(startMouseTop) {
    this.updateState({
        startMouseTop: startMouseTop
    });
}
function setStartMouseLeft(startMouseLeft) {
    this.updateState({
        startMouseLeft: startMouseLeft
    });
}
var _default = {
    enableDragging: enableDragging,
    disableDragging: disableDragging,
    isDragging: isDragging,
    getTimeout: getTimeout,
    startDragging: startDragging,
    stopDragging: stopDragging,
    dragging: dragging,
    callHandlers: callHandlers,
    resetTimeout: resetTimeout,
    updateTimeout: updateTimeout,
    getTopOffset: getTopOffset,
    getLeftOffset: getLeftOffset,
    getStartMouseTop: getStartMouseTop,
    getStartMouseLeft: getStartMouseLeft,
    setTopOffset: setTopOffset,
    setLeftOffset: setLeftOffset,
    setStartMouseTop: setStartMouseTop,
    setStartMouseLeft: setStartMouseLeft
};
exports.default = _default;
function mouseUpHandler(event, element) {
    _easy.window.off(_constants.BLUR, mouseUpHandler, this); ///
    _easy.window.offMouseUp(mouseUpHandler, this);
    _easy.window.offMouseMove(mouseMoveHandler, this);
    var dragging1 = this.isDragging();
    if (dragging1) {
        var explorer = this.getExplorer(), draggableEntry = this; ///
        explorer.stopDragging(draggableEntry, (function() {
            this.stopDragging();
        }).bind(this));
    } else {
        this.stopWaitingToDrag();
    }
}
function mouseDownHandler(event, element) {
    var button = event.button;
    _easy.window.on(_constants.BLUR, mouseUpHandler, this); ///
    _easy.window.onMouseUp(mouseUpHandler, this);
    _easy.window.onMouseMove(mouseMoveHandler, this);
    if (button === LEFT_MOUSE_BUTTON) {
        var dragging1 = this.isDragging();
        if (!dragging1) {
            var mouseTop = (0, _event).mouseTopFromEvent(event), mouseLeft = (0, _event).mouseLeftFromEvent(event);
            this.startWaitingToDrag(mouseTop, mouseLeft);
        }
    }
}
function mouseMoveHandler(event, element) {
    var dragging2 = this.isDragging();
    if (dragging2) {
        var mouseTop = (0, _event).mouseTopFromEvent(event), mouseLeft = (0, _event).mouseLeftFromEvent(event);
        this.dragging(mouseTop, mouseLeft);
    }
}

//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9taXhpbnMvZHJhZ2dhYmxlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgeyB3aW5kb3csIGNvbnN0YW50cyB9IGZyb20gXCJlYXN5XCI7XG5cbmltcG9ydCB7IG1vdXNlVG9wRnJvbUV2ZW50LCBtb3VzZUxlZnRGcm9tRXZlbnQgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL2V2ZW50XCI7XG5pbXBvcnQgeyBCTFVSLCBEUkFHR0lORywgU1RPUF9EUkFHR0lORywgU1RBUlRfRFJBR0dJTkcgfSBmcm9tIFwiLi4vY29uc3RhbnRzXCI7XG5cbmNvbnN0IHsgTEVGVF9NT1VTRV9CVVRUT04gfSA9IGNvbnN0YW50cztcblxuZnVuY3Rpb24gZW5hYmxlRHJhZ2dpbmcoKSB7XG4gIGNvbnN0IHRpbWVvdXQgPSBudWxsLFxuICAgICAgICB0b3BPZmZzZXQgPSBudWxsLFxuICAgICAgICBsZWZ0T2Zmc2V0ID0gbnVsbCxcbiAgICAgICAgc3RhcnRNb3VzZVRvcCA9IG51bGwsXG4gICAgICAgIHN0YXJ0TW91c2VMZWZ0ID0gbnVsbDtcblxuICB0aGlzLnNldFN0YXRlKHtcbiAgICB0aW1lb3V0LFxuICAgIHRvcE9mZnNldCxcbiAgICBsZWZ0T2Zmc2V0LFxuICAgIHN0YXJ0TW91c2VUb3AsXG4gICAgc3RhcnRNb3VzZUxlZnRcbiAgfSk7XG5cbiAgdGhpcy5vbk1vdXNlRG93bihtb3VzZURvd25IYW5kbGVyLCB0aGlzKTtcbn1cblxuZnVuY3Rpb24gZGlzYWJsZURyYWdnaW5nKCkge1xuICB0aGlzLm9mZk1vdXNlRG93bihtb3VzZURvd25IYW5kbGVyLCB0aGlzKTtcbn1cblxuZnVuY3Rpb24gaXNEcmFnZ2luZygpIHtcbiAgY29uc3QgZHJhZ2dpbmcgPSB0aGlzLmhhc0NsYXNzKFwiZHJhZ2dpbmdcIik7XG5cbiAgcmV0dXJuIGRyYWdnaW5nO1xufVxuXG5mdW5jdGlvbiBnZXRUaW1lb3V0KCkge1xuICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKSxcbiAgICAgICB7IHRpbWVvdXQgfSA9IHN0YXRlO1xuXG4gIHJldHVybiB0aW1lb3V0O1xufVxuXG5mdW5jdGlvbiBzdGFydERyYWdnaW5nKG1vdXNlVG9wLCBtb3VzZUxlZnQpIHtcbiAgY29uc3QgYm91bmRzID0gdGhpcy5nZXRCb3VuZHMoKSxcbiAgICAgICAgZXZlbnRUeXBlID0gU1RBUlRfRFJBR0dJTkcsXG4gICAgICAgIGJvdW5kc1RvcCA9IGJvdW5kcy5nZXRUb3AoKSxcbiAgICAgICAgYm91bmRzTGVmdCA9IGJvdW5kcy5nZXRMZWZ0KCksXG4gICAgICAgIHRvcE9mZnNldCA9IG1vdXNlVG9wIC0gYm91bmRzVG9wLFxuICAgICAgICBsZWZ0T2Zmc2V0ID0gbW91c2VMZWZ0IC0gYm91bmRzTGVmdCxcbiAgICAgICAgc3RhcnRNb3VzZVRvcCA9IG1vdXNlVG9wLCAvLy9cbiAgICAgICAgc3RhcnRNb3VzZUxlZnQgPSBtb3VzZUxlZnQsIC8vL1xuICAgICAgICByZWxhdGl2ZU1vdXNlVG9wID0gbW91c2VUb3AgLSBzdGFydE1vdXNlVG9wLFxuICAgICAgICByZWxhdGl2ZU1vdXNlTGVmdCA9IG1vdXNlTGVmdCAtIHN0YXJ0TW91c2VMZWZ0O1xuXG4gIHRoaXMuYWRkQ2xhc3MoXCJkcmFnZ2luZ1wiKTtcblxuICB0aGlzLnNldFRvcE9mZnNldCh0b3BPZmZzZXQpO1xuXG4gIHRoaXMuc2V0TGVmdE9mZnNldChsZWZ0T2Zmc2V0KTtcblxuICB0aGlzLnNldFN0YXJ0TW91c2VUb3Aoc3RhcnRNb3VzZVRvcCk7XG5cbiAgdGhpcy5zZXRTdGFydE1vdXNlTGVmdChzdGFydE1vdXNlTGVmdCk7XG5cbiAgdGhpcy5jYWxsSGFuZGxlcnMoZXZlbnRUeXBlLCByZWxhdGl2ZU1vdXNlVG9wLCByZWxhdGl2ZU1vdXNlTGVmdCk7XG5cbiAgdGhpcy5kcmFnZ2luZyhtb3VzZVRvcCwgbW91c2VMZWZ0KTtcblxuICAvLyBjb25zdCBleHBsb3JlciA9IHRoaXMuZ2V0RXhwbG9yZXIoKSxcbiAgLy8gICAgICAgZXNjYXBlS2V5U3RvcHNEcmFnZ2luZ09wdGlvblByZXNlbnQgPSBleHBsb3Jlci5pc09wdGlvblByZXNlbnQoRVNDQVBFX0tFWV9TVE9QU19EUkFHR0lORyk7XG4gIC8vXG4gIC8vIGlmIChlc2NhcGVLZXlTdG9wc0RyYWdnaW5nT3B0aW9uUHJlc2VudCkge1xuICAvLyAgIGNvbnN0IGtleURvd25IYW5kbGVyID0gdGhpcy5rZXlEb3duSGFuZGxlci5iaW5kKHRoaXMpO1xuICAvL1xuICAvLyAgIHRoaXMub25LZXlEb3duKGtleURvd25IYW5kbGVyKTtcbiAgLy8gfVxufVxuXG5mdW5jdGlvbiBzdG9wRHJhZ2dpbmcobW91c2VUb3AsIG1vdXNlTGVmdCkge1xuICAvLyBjb25zdCBleHBsb3JlciA9IHRoaXMuZ2V0RXhwbG9yZXIoKSxcbiAgLy8gICAgICAgZXNjYXBlS2V5U3RvcHNEcmFnZ2luZ09wdGlvblByZXNlbnQgPSBleHBsb3Jlci5pc09wdGlvblByZXNlbnQoRVNDQVBFX0tFWV9TVE9QU19EUkFHR0lORyk7XG4gIC8vXG4gIC8vIGlmIChlc2NhcGVLZXlTdG9wc0RyYWdnaW5nT3B0aW9uUHJlc2VudCkge1xuICAvLyAgIHRoaXMub2ZmS2V5RG93bigpO1xuICAvLyB9XG5cbiAgY29uc3QgZXZlbnRUeXBlID0gU1RPUF9EUkFHR0lORyxcbiAgICAgICAgc3RhcnRNb3VzZVRvcCA9IHRoaXMuZ2V0U3RhcnRNb3VzZVRvcCgpLFxuICAgICAgICBzdGFydE1vdXNlTGVmdCA9IHRoaXMuZ2V0U3RhcnRNb3VzZUxlZnQoKSxcbiAgICAgICAgcmVsYXRpdmVNb3VzZVRvcCA9IG1vdXNlVG9wIC0gc3RhcnRNb3VzZVRvcCxcbiAgICAgICAgcmVsYXRpdmVNb3VzZUxlZnQgPSBtb3VzZUxlZnQgLSBzdGFydE1vdXNlTGVmdDtcblxuICB0aGlzLmNhbGxIYW5kbGVycyhldmVudFR5cGUsIHJlbGF0aXZlTW91c2VUb3AsIHJlbGF0aXZlTW91c2VMZWZ0KTtcblxuICB0aGlzLnJlbW92ZUNsYXNzKFwiZHJhZ2dpbmdcIik7XG59XG5cbmZ1bmN0aW9uIGRyYWdnaW5nKG1vdXNlVG9wLCBtb3VzZUxlZnQpIHtcbiAgY29uc3QgZXZlbnRUeXBlID0gRFJBR0dJTkcsXG4gICAgICAgIHNjcm9sbFRvcCA9IHdpbmRvdy5nZXRTY3JvbGxUb3AoKSxcbiAgICAgICAgc2Nyb2xsTGVmdCA9IHdpbmRvdy5nZXRTY3JvbGxMZWZ0KCksXG4gICAgICAgIHRvcE9mZnNldCA9IHRoaXMuZ2V0VG9wT2Zmc2V0KCksXG4gICAgICAgIGxlZnRPZmZzZXQgPSB0aGlzLmdldExlZnRPZmZzZXQoKSxcbiAgICAgICAgc3RhcnRNb3VzZVRvcCA9IHRoaXMuZ2V0U3RhcnRNb3VzZVRvcCgpLFxuICAgICAgICBzdGFydE1vdXNlTGVmdCA9IHRoaXMuZ2V0U3RhcnRNb3VzZUxlZnQoKSxcbiAgICAgICAgcmVsYXRpdmVNb3VzZVRvcCA9IG1vdXNlVG9wIC0gc3RhcnRNb3VzZVRvcCxcbiAgICAgICAgcmVsYXRpdmVNb3VzZUxlZnQgPSBtb3VzZUxlZnQgLSBzdGFydE1vdXNlTGVmdDtcblxuICBsZXQgdG9wID0gc3RhcnRNb3VzZVRvcCArIHJlbGF0aXZlTW91c2VUb3AgLSB0b3BPZmZzZXQgLSBzY3JvbGxUb3AsXG4gICAgICBsZWZ0ID0gc3RhcnRNb3VzZUxlZnQgKyByZWxhdGl2ZU1vdXNlTGVmdCAtIGxlZnRPZmZzZXQgLSBzY3JvbGxMZWZ0O1xuXG4gIHRvcCA9IGAke3RvcH1weGA7IC8vL1xuICBsZWZ0ID0gYCR7bGVmdH1weGA7IC8vL1xuXG4gIGNvbnN0IGNzcyA9IHtcbiAgICB0b3AsXG4gICAgbGVmdFxuICB9O1xuXG4gIHRoaXMuY3NzKGNzcyk7XG5cbiAgdGhpcy5jYWxsSGFuZGxlcnMoZXZlbnRUeXBlLCByZWxhdGl2ZU1vdXNlVG9wLCByZWxhdGl2ZU1vdXNlTGVmdCk7XG5cbiAgY29uc3QgZXhwbG9yZXIgPSB0aGlzLmdldEV4cGxvcmVyKCk7XG5cbiAgZXhwbG9yZXIuZHJhZ2dpbmcodGhpcyk7XG59XG5cbmZ1bmN0aW9uIGNhbGxIYW5kbGVycyhldmVudFR5cGUsIHJlbGF0aXZlTW91c2VUb3AsIHJlbGF0aXZlTW91c2VMZWZ0KSB7XG4gIGNvbnN0IGV2ZW50TGlzdGVuZXJzID0gdGhpcy5maW5kRXZlbnRMaXN0ZW5lcnMoZXZlbnRUeXBlKTtcblxuICBldmVudExpc3RlbmVycy5mb3JFYWNoKChldmVudExpc3RlbmVyKSA9PiB7XG4gICAgY29uc3QgeyBoYW5kbGVyLCBlbGVtZW50IH0gPSBldmVudExpc3RlbmVyO1xuXG4gICAgaGFuZGxlci5jYWxsKGVsZW1lbnQsIHJlbGF0aXZlTW91c2VUb3AsIHJlbGF0aXZlTW91c2VMZWZ0KTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHJlc2V0VGltZW91dCgpIHtcbiAgY29uc3QgdGltZW91dCA9IG51bGw7XG5cbiAgdGhpcy51cGRhdGVUaW1lb3V0KHRpbWVvdXQpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVUaW1lb3V0KHRpbWVvdXQpIHtcbiAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgdGltZW91dFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0VG9wT2Zmc2V0KCkge1xuICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKSxcbiAgICAgICAgeyB0b3BPZmZzZXQgfSA9IHN0YXRlO1xuXG4gIHJldHVybiB0b3BPZmZzZXQ7XG59XG5cbmZ1bmN0aW9uIGdldExlZnRPZmZzZXQoKSB7XG4gIGNvbnN0IHN0YXRlID0gdGhpcy5nZXRTdGF0ZSgpLFxuICAgICAgICB7IGxlZnRPZmZzZXQgfSA9IHN0YXRlO1xuXG4gIHJldHVybiBsZWZ0T2Zmc2V0O1xufVxuXG5mdW5jdGlvbiBnZXRTdGFydE1vdXNlVG9wKCkge1xuICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKSxcbiAgICAgIHsgc3RhcnRNb3VzZVRvcCB9ID0gc3RhdGU7XG5cbiAgcmV0dXJuIHN0YXJ0TW91c2VUb3A7XG59XG5cbmZ1bmN0aW9uIGdldFN0YXJ0TW91c2VMZWZ0KCkge1xuICBjb25zdCBzdGF0ZSA9IHRoaXMuZ2V0U3RhdGUoKSxcbiAgICAgIHsgc3RhcnRNb3VzZUxlZnQgfSA9IHN0YXRlO1xuXG4gIHJldHVybiBzdGFydE1vdXNlTGVmdDtcbn1cblxuZnVuY3Rpb24gc2V0VG9wT2Zmc2V0KHRvcE9mZnNldCkge1xuICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICB0b3BPZmZzZXRcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNldExlZnRPZmZzZXQobGVmdE9mZnNldCkge1xuICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICBsZWZ0T2Zmc2V0XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBzZXRTdGFydE1vdXNlVG9wKHN0YXJ0TW91c2VUb3ApIHtcbiAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgc3RhcnRNb3VzZVRvcFxuICB9KTtcbn1cblxuZnVuY3Rpb24gc2V0U3RhcnRNb3VzZUxlZnQoc3RhcnRNb3VzZUxlZnQpIHtcbiAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgc3RhcnRNb3VzZUxlZnRcbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgZW5hYmxlRHJhZ2dpbmcsXG4gIGRpc2FibGVEcmFnZ2luZyxcbiAgaXNEcmFnZ2luZyxcbiAgZ2V0VGltZW91dCxcbiAgc3RhcnREcmFnZ2luZyxcbiAgc3RvcERyYWdnaW5nLFxuICBkcmFnZ2luZyxcbiAgY2FsbEhhbmRsZXJzLFxuICByZXNldFRpbWVvdXQsXG4gIHVwZGF0ZVRpbWVvdXQsXG4gIGdldFRvcE9mZnNldCxcbiAgZ2V0TGVmdE9mZnNldCxcbiAgZ2V0U3RhcnRNb3VzZVRvcCxcbiAgZ2V0U3RhcnRNb3VzZUxlZnQsXG4gIHNldFRvcE9mZnNldCxcbiAgc2V0TGVmdE9mZnNldCxcbiAgc2V0U3RhcnRNb3VzZVRvcCxcbiAgc2V0U3RhcnRNb3VzZUxlZnRcbn07XG5cbmZ1bmN0aW9uIG1vdXNlVXBIYW5kbGVyKGV2ZW50LCBlbGVtZW50KSB7XG4gIHdpbmRvdy5vZmYoQkxVUiwgbW91c2VVcEhhbmRsZXIsIHRoaXMpOyAgLy8vXG5cbiAgd2luZG93Lm9mZk1vdXNlVXAobW91c2VVcEhhbmRsZXIsIHRoaXMpO1xuXG4gIHdpbmRvdy5vZmZNb3VzZU1vdmUobW91c2VNb3ZlSGFuZGxlciwgdGhpcyk7XG5cbiAgY29uc3QgZHJhZ2dpbmcgPSB0aGlzLmlzRHJhZ2dpbmcoKTtcblxuICBpZiAoZHJhZ2dpbmcpIHtcbiAgICBjb25zdCBleHBsb3JlciA9IHRoaXMuZ2V0RXhwbG9yZXIoKSxcbiAgICAgICAgICBkcmFnZ2FibGVFbnRyeSA9IHRoaXM7ICAvLy9cblxuICAgIGV4cGxvcmVyLnN0b3BEcmFnZ2luZyhkcmFnZ2FibGVFbnRyeSwgKCkgPT4ge1xuICAgICAgdGhpcy5zdG9wRHJhZ2dpbmcoKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICB0aGlzLnN0b3BXYWl0aW5nVG9EcmFnKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbW91c2VEb3duSGFuZGxlcihldmVudCwgZWxlbWVudCkge1xuICBjb25zdCB7IGJ1dHRvbiB9ID0gZXZlbnQ7XG5cbiAgd2luZG93Lm9uKEJMVVIsIG1vdXNlVXBIYW5kbGVyLCB0aGlzKTsgLy8vXG5cbiAgd2luZG93Lm9uTW91c2VVcChtb3VzZVVwSGFuZGxlciwgdGhpcyk7XG5cbiAgd2luZG93Lm9uTW91c2VNb3ZlKG1vdXNlTW92ZUhhbmRsZXIsIHRoaXMpO1xuXG4gIGlmIChidXR0b24gPT09IExFRlRfTU9VU0VfQlVUVE9OKSB7XG4gICAgY29uc3QgZHJhZ2dpbmcgPSB0aGlzLmlzRHJhZ2dpbmcoKTtcblxuICAgIGlmICghZHJhZ2dpbmcpIHtcbiAgICAgIGNvbnN0IG1vdXNlVG9wID0gbW91c2VUb3BGcm9tRXZlbnQoZXZlbnQpLFxuICAgICAgICAgICAgbW91c2VMZWZ0ID0gbW91c2VMZWZ0RnJvbUV2ZW50KGV2ZW50KTtcblxuICAgICAgdGhpcy5zdGFydFdhaXRpbmdUb0RyYWcobW91c2VUb3AsIG1vdXNlTGVmdCk7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIG1vdXNlTW92ZUhhbmRsZXIoZXZlbnQsIGVsZW1lbnQpIHtcbiAgY29uc3QgZHJhZ2dpbmcgPSB0aGlzLmlzRHJhZ2dpbmcoKTtcblxuICBpZiAoZHJhZ2dpbmcpIHtcbiAgICBjb25zdCBtb3VzZVRvcCA9IG1vdXNlVG9wRnJvbUV2ZW50KGV2ZW50KSxcbiAgICAgICAgICBtb3VzZUxlZnQgPSBtb3VzZUxlZnRGcm9tRXZlbnQoZXZlbnQpO1xuXG4gICAgdGhpcy5kcmFnZ2luZyhtb3VzZVRvcCwgbW91c2VMZWZ0KTtcbiAgfVxufVxuIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJDQUFBLFVBQVk7Ozs7O0lBRXNCLEtBQU07SUFFYyxNQUFvQjtJQUNaLFVBQWM7SUFFcEUsaUJBQWlCLEdBTFMsS0FBTSxXQUtoQyxpQkFBaUI7U0FFaEIsY0FBYztRQUNmLE9BQU8sR0FBRyxJQUFJLEVBQ2QsU0FBUyxHQUFHLElBQUksRUFDaEIsVUFBVSxHQUFHLElBQUksRUFDakIsYUFBYSxHQUFHLElBQUksRUFDcEIsY0FBYyxHQUFHLElBQUk7U0FFdEIsUUFBUTtRQUNYLE9BQU8sRUFBUCxPQUFPO1FBQ1AsU0FBUyxFQUFULFNBQVM7UUFDVCxVQUFVLEVBQVYsVUFBVTtRQUNWLGFBQWEsRUFBYixhQUFhO1FBQ2IsY0FBYyxFQUFkLGNBQWM7O1NBR1gsV0FBVyxDQUFDLGdCQUFnQjs7U0FHMUIsZUFBZTtTQUNqQixZQUFZLENBQUMsZ0JBQWdCOztTQUczQixVQUFVO1FBQ1gsUUFBUSxRQUFRLFFBQVEsRUFBQyxRQUFVO1dBRWxDLFFBQVE7O1NBR1IsVUFBVTtRQUNYLEtBQUssUUFBUSxRQUFRLElBQ3BCLE9BQU8sR0FBSyxLQUFLLENBQWpCLE9BQU87V0FFUCxPQUFPOztTQUdQLGFBQWEsQ0FBQyxRQUFRLEVBQUUsU0FBUztRQUNsQyxNQUFNLFFBQVEsU0FBUyxJQUN2QixTQUFTLEdBekM2QyxVQUFjLGlCQTBDcEUsU0FBUyxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQ3pCLFVBQVUsR0FBRyxNQUFN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